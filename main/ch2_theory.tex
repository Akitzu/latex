\chapter{Poincare map}
\newcommand{\dpmap}{\mathcal{D}\mathcal{P}}
\newcommand{\pmap}{\mathcal{P}}
\newcommand{\nfp}{n_\text{fp}}
\newcommand{\z}{z}

In the study of continuous dynamical systems, it is often convenient to consider a discrete map defined by the intersection of the trajectories with a lower-dimensional subspace and which captures some properties of the continuous case. For particles following the magnetic field of a toroidal apparatus, the intersection of their trajectories with a constant $\phi$ cross-section reveals the distinct region of different field line behaviour~: closed surfaces, islands, chaotic regions, and is known as a \textit{Poincare} section.

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/theory/w7x.png}
        \caption{W7-X, $\nfp = 5$}
        \label{fig:w7x-default}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/theory/ncsx.png}
        \caption{NCSX, $\nfp = 3$}
        \label{fig:ncsx-default}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.32\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/theory/lhd.png}
        \caption{LHD, $\nfp = 10$}
        \label{fig:enter-label}
    \end{subfigure}

    \caption{Poincare section at $\phi = 0$ for (a) Wendelstein-7X, (b) the (aborted) National Compact Stellarator Experiment and (c) the Large Helical Device stellarator. The field lines are trace using Runge Kutta Dopri5.}\label{fig:poincare-example}
    \label{fig:enter-label}
\end{figure}

Using Biot-Savart law to get the field generated from the known currents and coil geometry and by neglecting the gyro-motion around the field lines, the crossings can be numerically recorded. In \figref{fig:poincare-example} the Poincaré sections for three well known devices are computed using Runge-Kutta integration scheme. The closed flux surfaces appear from the magnetic axis up to the edge region. For W7-X and NCSX configuration, one island is predominant. For LHD on the contrary, the edge region is chaotic and multiple small islands are present in the chaotic edge region. Such a figure can be produced experimentally in stellarators by firing an electron beam, sweeping a fluorescent rod and using a long camera exposure \cite{pedersen_confirmation_2016}. To define a map that gives the evolution of the position of the crossings in the $\phi$ semi-plane, first note that for each initial point $\textbf{x}_0$ there is an associated curve $\gamma(t)$ depending on time which is link to the flow $\gamma(t) = \Phi(\textbf{x}_0, t)$ of the magnetic vector field. The cylindrical coordinates are a natural choice here.

\noindent
\makebox[\textwidth]{%
  \begin{tcolorbox}[colback=lightgray!10, colframe=black, width=0.85\textwidth, boxrule=0.5mm, sharp corners]
    \textbf{Geometric consideration} : Throughout this document, the convention adpoted is that of the contravariant component for vectors. That is, for example, $\textbf{B}$ in cylindrical coordinates has the form $B^R = \textbf{B}\cdot\nabla R$, $B^\phi = \textbf{B}\cdot\nabla\phi$ and $B^Z = \textbf{B}\cdot\nabla Z$. In the formalism of differential geometry, one writes $B=B^i\partial_i$. The basis $\{\partial_i\}_i$ is orthogonal and holonomic but the element may not be unitary, as for $\partial_\phi$. On the other hand, the component in the common orthonormal basis $e_i$ will be written with subscript as $\tilde{B}^i$. [SEE APP]
  \end{tcolorbox}
}

The trajectory curve $\gamma : \mathbb{R}\rightarrow\mathbb{R}^+\times[0,2\pi[\times\mathbb{R} \eqqcolon \mathcal{M}$, $t \mapsto \gamma(t) = (R(t),\,\phi(t),\,Z(t))$ we are interested in is such that the tangent vector at each point is given by $\dot{\gamma}(t)= \textbf{B} = B^i\partial_i \in T_{\gamma(t)}\mathcal{M}$. Specifying the initial point $\gamma(0) = \textbf{x}_0$ identifies a specific curve~:
\begin{align*}
    \gamma(t) = \int_0^t\dot{\gamma}(s)ds + \textbf{x}_0 \quad \text{with} \quad   \dot{\gamma}^i(t)= (\frac{dR}{dt},\,\frac{d\phi}{dt},\,\frac{dZ}{dt}) = (B^R, B^\phi, B^Z).
\end{align*}
Provided that the sign of $B^\phi(R, \phi, Z)$ is either positive or negative on $\gamma$, $B^\phi$ is never zero, the map~:
\begin{equation*}
    t(\phi) = \int \frac{dt}{d\phi}d\phi = \int_0^\phi \frac{1}{B^\phi}d\phi
\end{equation*}

defines a handy change of variable for which the $\phi$ evolution is linear. Indeed $\gamma$ can be re-parameterized as $\phi \mapsto \gamma(\phi) = (R(\phi),\,\phi,\,Z(\phi))$ with~$\dot{\gamma}$~:
\begin{equation*}
    \dot{\gamma}^i(\phi) = (\frac{dR}{d\phi},\,1,\,\frac{dZ}{d\phi}) = (\frac{dR}{dt}\frac{dt}{d\phi},\,1,\,\frac{dZ}{dt}\frac{dt}{d\phi}) = (B^R/B^\phi,\, 1,\,B^Z/B^\phi).
\end{equation*}
Due to the choice of coordinates the field will have at most a $\phi$ periodicity of $2\pi$, yet in stellarator configurations have azymuthal redundancy. Their period is $T = 2\pi/n_\text{fp}$ where $n_\text{fp}\in\mathbb{N}^\star$ is the number of field period in a complete toroidal rotation. For example, W7X and LHD have 5 and 10 field periods respectively. If the field is not periodic then $n_\text{fp} = 1$ and, in contrast, for an axisymmetric device without defaults $n_\text{fp} = +\infty$, the case of ideal Tokamaks.

The Poincare section is hence identical for $\phi_i$ and $\phi_i+kT$, $k\in\mathbb{Z}$. Writing $\Omega$ the set of initial points in the $\phi_i$ plane for which $\gamma$ is effectively re-parametrizable between $\phi_i$ and $\phi_i + T$, allows to define the map $\pmap : \Omega \rightarrow \mathbb{R}_+\times\mathbb{R}$ as~:
\begin{equation*}
    (\tilde{R},\tilde{Z}) \mapsto \pmap(\tilde{R},\tilde{Z}) = \int_{\phi_i}^{\phi_i+T}(
        \dot{\gamma}^R(s),\,
        \dot{\gamma}^Z(s)
    )\,ds + (\tilde{R},\tilde{Z})
\end{equation*}
with $\textbf{x}_0 = (\tilde{R},\,\phi_i,\,\tilde{Z})$. \figref{fig:th-poincare-map} represent an hypothetical $\nfp = 3$ configuration where an initial starting point $z_0\coloneqq (\tilde{R}_i,\tilde{Z}_i)$ gets map to the $\phi_i + T$ cross section. The evolution of the intersection for $z_0$ is then simply $z_{i+1} = \pmap(z_i)$ and $z_n = \pmap^n(z_0)$. 

\begin{figure}[H]
    \centering
    \includegraphics{images/theory/poincare-torus.pdf}
    \caption{Trajectory of a particle in a toroidal device (Tokamak/Stellarator) from a starting point $(\tilde{R}, \tilde{Z})$ in a $\phi = \phi_i$ section to a point in the $\phi = \phi_i + T$ plane with $T$ the azymuthal periodicity of the magnetic field.}
    \label{fig:th-poincare-map}
\end{figure}

As the evolution is performed by following $\mathbf{B}$ and due to the magnetic field been divergence free $\nabla\cdot\textbf{B} = 0$, the flux through any surface obtained by mapping a simple path in $\phi_i$ to $\phi_i + T$ will be zero. This result in the key property of $\pmap$ being flux-conserving ; the flux through any closed surface $\Sigma \subset \Omega$ is equal to the one through $\pmap(\Sigma)$~:
\begin{equation*}
    \iint\limits_{\Sigma}\textbf{B}\cdot\textbf{dS} = \iint\limits_{\pmap(\Sigma)}\textbf{B}\cdot\textbf{dS}.
\end{equation*}
The determinant of the Jacobian matrix for a general flow $\Phi(\textbf{x}_0, t)$ of a vector field $v$, which does not depend on time, is related to the divergence of $v$ \cite[p.408]{hirsch_differential_2013} by~:
\begin{equation}\label{eq:det-div-flow}
    \text{det}(\mathcal{D}\Phi(\textbf{x}_0, t)) = \text{det}(\mathcal{D}\Phi(\textbf{x}_0, 0))\exp\left(\int_0^t\text{Tr}(\nabla v(s)) ds\right) = \exp\left(\int_0^t \nabla\cdot v(s) ds\right)
\end{equation}
with $v(\Phi(\textbf{x}_0, s))$ written implicitly as $v(s)$. In the case of the flow in cylindrical coordinates, \citeauthor{wei_invariant_2023} use \equref{eq:det-div-flow} to derive the relation~(Eq.8):
\begin{equation*}\label{eq:det-div-pmap}
    \text{det}(\mathcal{D}\Phi(\textbf{x}_0, \phi_i, \phi_e)) = \exp\left(\int_{\phi_i}^{\phi_e} \frac{R\,(\nabla\cdot v)}{\tilde{v}^\phi} ds\right)\frac{\tilde{v}^\phi(\phi_i)}{\tilde{v}^\phi(\phi_e)}.
\end{equation*}
It gives for the determinant of $\dpmap \in \mathbb{R}^{2\times2}$ that~:
\begin{equation}\label{eq:pmap-det}
    \text{det}(\dpmap(\tilde{R}, \tilde{Z})) = B^\phi(\tilde{R},\phi_i, \tilde{Z})/B^\phi(\pmap^{\tilde{R}}(\tilde{R},\tilde{Z}), \phi_i+T,\pmap^{\tilde{Z}}(\tilde{R},\tilde{Z})).
\end{equation}
The last identity may also be recovered more directly using differential forms as in \cite{meiss_thirty_2015}, the derivation is given in \appref{forms}.

\section{Fixed points}
Periodic orbit of the Poincaré map $\pmap$ are particularly important as they define field line that are close. The magnetic axis, whose existence is guaranteed by the Hairy ball theorem, is a closed field line that has only one intersection with any $\phi$ plane. Therefore the point $\z_0\in\Omega$ describing this intersection is a fixed point $\pmap^1(\z_0) = \z_0$. In general a fixed point $z^\star\in\Omega$ is of order $k\in\mathbb{N}^\star$ if $\pmap^k(\z^\star) = \z^\star$ and $\pmap^j(\z^\star) \neq \z^\star$ for $j < k$.

It's worth noting that the toroidal geometry of the magnetic field requires the field lines to twist around the magnetic axis in order to average out the $\nabla\textbf{B}$ drift. The twisting is quantify by the rotational transform $\iotaslash$ which indicates the fraction of poloidal turns
performed after one toroidal turn. More precisely, if $\iotaslash$ is rational, one can write $\iotaslash = n/m$ which means that after $m$ toroidal turns the field line will have wrapped around the magnetic axis poloidally $n$ times. In Tokamaks, due to its relation with magnetohydrodynamic stability limit, it is more common to use the safety factor $q=1/\iotaslash$.

Magnetic islands (chains) are present at rational $\iotaslash$ values. After $m$ toroidal turns, the initial starting point $\z^\star$ returns to itself and, recalling that there is $\nfp$ Poincaré sections in a toroidal turn, the order of the fixed point is at most $k=m\nfp$. Furthermore, as the field line makes $m$ turns, it will intersect a constant $\phi$ semi-plane exactly $m$ times. Using the periodicity of the field we see that after $m$ iterations the point will already be back to itself and $\pmap^m(\z^\star) = \z^\star$. The order of $\z^\star$ is thus $k=m$ and the poloidal winding angle will be only $2\pi\cdot n/\nfp$ for $m$ iterations. 

When $g = \gcd{(m,\,n)} = 1$ one island rotates 
$k = m/gcd(\nfp, n)$


It is the case in \figref{fig:ncsx-default} were $\iotaslash = 3/7$. There is one island that rotates around the magnetic axis and gives the 7 intersections. When $g \neq 1$ on the other hand, there are $g$ different island rotating. 

We see this for \figref{fig:w7x-default} were $\iotaslash = 5/5$. There are five different islands.

In term of the number of orbit
and recording the $\pmap^j(\z^\star)$ for $j = 1, ..., k$ of one O-point and one X-point is enough to recover all of their coordinates.



To distinguish between O and X points, the behaviour of nearby field lines can be described using the Taylor expansion~:
\begin{equation*}
    \pmap^k(\z^\star+\delta \z) = \z^\star + \langle\dpmap^k\vert_{\z^\star},\, \delta\z\rangle + \smallO(\Vert\delta\z\Vert^2)
\end{equation*}
by the jacobian and especially by its eigenvalues $\lambda_1$ and $\lambda_2$. Using \equref{eq:pmap-det}, the determinant of $\dpmap^k\vert_{\z^\star}$  is equal to 1 which is equivalent as stating that the matrix is an element of $\text{SL}(2,\mathbb{R})$. Depending on the value of the trace or equivalently on the value of the Greenes Residue $\mathcal{R} = \frac{1}{2} - \frac{1}{4}\text{Tr}(\dpmap^k\vert_{\z^\star})$, the eigenvalues are either~:
\begin{enumerate}
    \item Complex conjugate and of modulus 1 ; $\lambda_{1,2} = e^{\pm i\theta}$, when $\vert \text{Tr}(\dpmap^k\vert_{\z^\star})\vert < 2$ and $0 < \mathcal{R} < 1$. They indicate rotation around the fixed point which is the behaviour of an O-point.
    \item Both real with $\vert\lambda_s\vert < 1$ and $\vert\lambda_u\vert > 1$, when $\vert \text{Tr}(\dpmap^k\vert_{\z^\star})\vert > 2$ and $\mathcal{R}$.
    \item $\lambda_1 = \lambda_2 = \pm 1$
\end{enumerate}

we want to differentiate between $\lambda_s, \lambda_u < 0$ and $\lambda_s, \lambda_u > 0$. In fact due to more topologycal resons the the O/X point and the alternating hyperbolic are o points.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{images/theory/smeit_sawtooth.jpg}
    \caption{[insert the image from sawtooth here $\dpmap$ is written as $M$ \cite{smiet_bifurcations_2020}.}
    \label{fig:enter-label}
\end{figure}


The method to find fixed point is simply using the newton algorithm, details in the appendix, however we see that the region of convergence are not big.

\begin{figure}[H]
    \subfloat[5/5 island in]{%
        \includegraphics[width=0.5\textwidth]{example-image-a}
    }
    \hfill
    \subfloat[Ncsx 7/3]{%
        \includegraphics[width=0.5\textwidth]{example-image-c}
    }
    \caption{}
\end{figure}

the sensitivity to initial conditions.

%%% -- CHAPTER --- %%%
\chapter{Toybox}
An analytical magnetic geometry is introduced to provide a simpler and more flexible approach to field line tracing analysis than treating the geometry of a complex toroidal device, as well as to validate the numerical calculation of further algorithms. Due to the linearity of the curl operator, a sum of vector potentials $\textbf{A}_i$ has a one-to-one correspondence with the element of the resulting magnetic fields $\textbf{B}_i$. Defining the model in this way has the advantage of making it possible to use automatic differentiation from the 
\href{https://jax.readthedocs.io/en/latest/index.html}{\textcolor{blue}{\textit{JAX}}}
package \cite{bradbury_jax_2018}. The vector potential is the only quantity that needs to be defined analytically. The resulting $\textbf{B}$ or, in fact, any derivative of any reasonable order of $A$ can then be computed. A tokamak-like equilibrium is implemented as the basis of this so-called \textit{Toybox}.

More specifically in axisymmetric equilibria (i.e. perfect Tokamaks), following e.g \cite[p.108]{wesson_tokamaks_2011}, the shape of the magnetic surfaces are well defined by the flux function  $\psi$. Indeed, for cylindrical coordinates, all components/functions are constant along $\phi$, which yields~:
\begin{align*}
    \textbf{B} = B^i\partial_i = -\frac{1}{R}\frac{\partial\psi}{\partial Z}\partial_R +\frac{1}{R}\frac{\partial\psi}{\partial R}\partial_Z + \left(\frac{\partial A^R}{\partial Z} - \frac{\partial A^Z}{\partial R}\right)\partial_\phi.
\end{align*}
with $\psi = R^2 A^\phi$. The choice of Gauge can be exploited to assume $A^Z = 0$. For completeness, note that in the formulation of the Grad-Sharfranov equation, the $B^\phi$ term is related to a function $F(\psi)$ as $B^\phi = (\mu_0) F/R^2$.

A convenient geometry to study for the flux surfaces is nested toroids centered on the magnetic axis of RZ-coordinates $(R_0, Z_0)$. Introducing toroidal coordinates $(\rho, \phi, \theta)$, with $\rho$ the distance from the axis, the poloidal flux is thus $\psi(R, Z) \propto (R - R_0)^2 + (Z - Z_0)^2 = \rho^2$. In fact, due to the freedom in the dimension of the implementation, the equality can be choosen. For large aspect ratio tokamaks $R_0/\rho >> 1$ the safety factor profile can be approximated by~:
\begin{align*}
    q \approx \frac{\Delta\phi}{\Delta\theta} = \frac{\rho \tilde{B}^\phi}{R_0 \tilde{B}^\theta} = \frac{2\pi}{\mu_0\tilde{I}^\phi R_0} \rho^2
\end{align*}
calculating the multipole expansion of $\tilde{B}^\theta$ only up to first order. The $\tilde{B}^\phi$ component and the plasma current $\tilde{I}^\phi$ are imposed by the toroidal field coils and the central solenoid respectively. It would be desirable to achieve this quadratic behaviour of $q$ in the tokamak model as well. In more details, the $q$-profile can be calculated in a single $\phi$ section by integrating over the poloidal closed curve defined by $\psi = \text{const}$ \cite[pp.111-112]{wesson_tokamaks_2011}. In this specific case, as $\psi = \rho^2$, this path simply reduce to an integration over $\theta$ as~:
\begin{align}\label{eq:q-profile-th}
    q(\rho) = \frac{1}{2\pi}\int\limits_0^{2\pi} \frac{d\phi}{d\theta}d\theta = \frac{1}{2\pi}\int\limits_0^{2\pi} \frac{B^\phi}{B^\theta}d\theta.
\end{align}
The $\theta$ component can be derived directly from coordinate transformation, as follows~:
\begin{align*}
    B^\theta = \frac{\cos{\theta}}{\rho}B^Z - \frac{\sin{\theta}}{\rho}B^R = \frac{2}{R} = \frac{2}{R_0+\rho\cos{\theta}}.
\end{align*}
The $\phi$ component of $\textbf{B}$ is introduced heuristically as~:
\begin{align*}
    B^\phi = 2\sqrt{R^2-\rho^2}\,(\text{sf}+\frac{\text{shear}}{2}\rho^2)/R^2
\end{align*}
with its corresponding $A^R$ provided in \appref{sec:jaxpot}. Inserting $B^\theta$ and $B^\phi$ in \eqref{eq:q-profile-th} gives~:
\begin{align*}
     q(\rho) = (\text{sf}+\frac{\text{shear}}{2}\rho^2)\frac{\sqrt{R^2-\rho^2}}{2\pi}\int\limits_{0}^{2\pi}\frac{1}{R_0 + \rho\cos{\theta}}d\theta = \text{sf}+\frac{\text{shear}}{2}\rho^2
\end{align*}
where the last two term cancel for $\rho < R$. At this point, we can make sense of the sf and shear constants as the on axis safety factor and the actual shear $dq/d\rho$. \figref{fig:toyha-basis-p} shows the cross section obtained by tracing the field line over a full toroidal revolution for the equilibrium with $R_0 = 6$, $Z_0 = 0$, $\text{sf} = 0.8875$ and $\text{shear} = 0.4$. While the effective number of field periods is $\nfp = \infty$, calculating the Poincare section by integrating over $2\pi$ remains correct even when perturbations are added and the axisymmetry breaks. The density of intersections is higher on the inside than on the outside. Since $B^\rho = 0$ and $\Tilde{B}^\phi/\tilde{B}^\theta \propto \sqrt{(\rho/R)^2-1}$ for constant $\rho$, a field line revolves faster in $\phi$ when $\theta \sim \pi$ then when $\theta \sim 0$ and thus make more crossings.

\begin{figure}
    \centering
    \begin{subfigure}[t]{0.43\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/high-aspect-ratio/unperturbed.pdf}
        \caption{\label{fig:toyha-basis-p}}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.54\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/high-aspect-ratio/iota_q.pdf}
        \caption{\label{fig:toyha-basis-iotaq}}
    \end{subfigure}
    \caption{High aspect ratio Toy-Tokamak equilibrium with $R_0 = 6$, $Z_0 = 0$, $\text{sf} = 0.8875$ and $\text{shear} = 0.4$. (a) Poincar\'e section computed with Runge-Kutta algorithm. (b) Rotational transform $\iota/2\pi$ and $q$ profile with respect to the distance $\rho$ from the axis.}
    \label{fig:toyha-basis}
\end{figure}

The rotational transform $\iotaslash$ of field lines are computed by integrating both the field line themselves and the magnetic axis, tracking the evolution of the winding. Performing such a calculation for starting points of the form $(R_0+\rho,0)$ with $\rho\in [0, 2]$ gives the $\iotaslash$ profile in \figref{fig:toyha-basis-iotaq}. The calculated $q$-profile is in great agreement with its analytical form, which is reassuring.

An essential feature of the diverted tokamak edge structure is the separatrix. Combining a quadratic $q$ equilibrium with the field generated by a circular current loop at appropriate position and amplitude will result in a single null equilibrium. The vector potential of a curent loop at position $(R_l, 0)$ is given in \cite{simpson_simple_2001} as~:
\begin{align*}
    A^\phi = \frac{\mu_0}{4\pi}\frac{4IR_l}{\beta R}\left(\frac{(2-k^2)K(k^2)-2E(k^2)}{k^2}\right).
\end{align*}
with $K, E$ the complete elliptic integral of the first and second kind and with $\alpha^2 = (R_l-R)^2 + Z^2$, $\beta^2 = (R_l+R)^2+Z^2$ and $k = 1 - \alpha^2/\beta^2$. To get a general position from this expression, $Z$ can be substituted  with $Z-Z_l$.

The superposition of $\psi_{sep}$ with $I = 10\,\pi/\mu_0$, $R_l = 6$ and $Z_l = -5.5$ on the $\psi_{eq}$ for nested toroids with $R_0 = 6, Z_0 = 0, \text{sf} = 0.91, \text{shear} = 1.2$ is shown in \figref{fig:toytok-base-psi}. $\psi_{sep}$ produces only a field lying in the poloidal plane, and by taking the current direction in the loop identical to the direction of $B^\phi_{eq}$, the poloidal component of the field cancels out somewhere between the former axis and the position of the loop, producing the desired X-point. The resulting analytical Tokamak equilibrium is shown in \figref{fig:toytok-base-p}. The separatrix appears clearly. It can be appreciated that for small distances with respect to the axis the $q$-profile is still quadratic \figref{fig:toytok-base-p} and tends to infinity as it approaches the separatrix.

\begin{figure}[H]
    \centering
    \begin{minipage}{0.45\textwidth} % Adjust width as needed
        \centering
        \begin{subfigure}[b]{\textwidth}
            \centering
            \includegraphics[width=\textwidth]{images/toytok/unperturbed/sepflux.png}
            \caption{}
            \label{fig:toytok-base-psi}
        \end{subfigure}
        \vfill
        \vspace{10px}
        \vfill
        \begin{subfigure}[b]{0.99\textwidth}
            \centering
            \includegraphics[width=\textwidth]{images/toytok/unperturbed/q-iota-squared.png}
            \caption{}
            \label{fig:toytok-base-iotaq}
        \end{subfigure}
    \end{minipage}%
    \begin{minipage}{0.5\textwidth} % Adjust width as needed
        \centering
        \begin{subfigure}[b]{\textwidth}
            \centering
            \includegraphics[width=\textwidth]{images/toytok/unperturbed/poincare.png}
            \caption{}
            \label{fig:toytok-base-p}
        \end{subfigure}
    \end{minipage}
    \caption{Analytical Tokamak equilibrium obtained by (a) the addition of the $\psi_{sep}$ function generated by a current loop on top of a high aspect-ratio toroids equilibrium. (b) $\iota/2\pi$ and $q$ profiles and (c) resulting Poincaré section.}
    \label{fig:toytok-base}
\end{figure}

\section{Perturbations}
The \textit{ToyTok} is not chaotic and will make it not axisymmetric anymore.


the hamiltonian formalism is describe for instance in \cite{viana_hamiltonian_2023} or in
\cite{escande_description_2024} $\delta\textbf{A} = -\delta\psi_P\nabla\phi/2\pi$ which is adding adding in straight field line coordinates with. 

In 

In the toroidal coordinates the $\phi$ and $\theta$ angles are both $\in [0, 2\pi)$ with $R_\text{max}(\theta)$ and thus one can develop any component into Fourier series as for the magnetic vector potential $\textbf{A}$.
\begin{align*}
    A^i(\rho,\phi,\theta) = \sum\limits_{n\in\mathbb{N}}\sum\limits_{m\in\mathbb{N}} A^i(\rho)\cos(n\phi + \varphi_n)\cos(m\theta + \varphi_m)
\end{align*}
One perturbation mode pair $(m,n)$ and remembering that the equilibrium is axisymmetric, thus one can choose the $\phi$ origin such that $\varphi_m = 0$, the perturbation becomes a choice of $\psi(\rho) = f(\rho)$.

Here the two choices~:

\begin{enumerate}
    \item $f(\rho, \mu, \sigma) = \frac{1}{\sqrt{2\pi\sigma^2}}\exp\left(\frac{-(\rho-\mu)^2}{2\sigma^2}\right)$ from the Normal distribution
    
    \item $f(\rho, d) = \frac{\sqrt{2}}{\sqrt{\pi}}\frac{\rho^2}{d^3}\exp\left(\frac{-\rho^2}{2d^2}\right)$ from the Maxwell-Boltzmann distribution
\end{enumerate}

In fact, the transformation to toroidal does not have to be the one of a circle. One can, for instance, find the flux coordinate for a tokamak equilibrium. Here only a generalization to an ellipsoid is implemented~:
\begin{align*}
    \rho &= \sqrt{\left(\frac{R-R_a}{A}\right)^2 + \left(\frac{Z-Z_a}{B}\right)^2}\\
    \phi &= \phi\\
    \theta &= \text{arctan2}(\frac{Z-Z_a}{B}, \frac{R-R_a}{A})\\
\end{align*}

and when straight field line coordinate are defined, one can transform $\theta$ and $\rho$ to be the 

talk about mode mixing : this is an choice in the way we apply the perturbation to mix mode.
Chirikov overlap parameter

\begin{figure}[h!]
    \centering
    \begin{subfigure}[t]{0.55\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/high-aspect-ratio/psi_pert.png}
        \caption{}
        \label{fig:toyha-32-psi}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.43\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/high-aspect-ratio/perturbed_3_2.png}
        \caption{}
        \label{fig:toyha-32-p}
    \end{subfigure}
    \caption{}
    \label{fig:toyha-32}
\end{figure}

we can see that they follow the field on the trargeted q for the high aspect and at the separatrix for the toytok. 

however the toroidal coordinates are not the straight field and if we plot at a $\rho = const$ we can see that

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/high-aspect-ratio/fieldlines.png}
    \caption{Angle between $B^\phi$ and $\textbf{B}$ in radian against the $\theta$ and $\phi$ angle for the magnetic surface $\rho = 1.75$.\label{fig:mode-mixing}}
\end{figure}

\figref{fig:mode-mixing} shows that while the field for the $B^\rho = 0$ we are not in straight field line coordinate as the angle clearly changes with respect to the $\theta$ and $\phi$ values. 

The coordinate transformation [cite] 
It induces chaos quickly as one can 

\begin{figure}
    \centering
    \begin{subfigure}{0.57\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/toytok/perturbed-6-1/psi_pert.png}
        \caption{}
        \label{fig:toytok-61-psi}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.41\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/toytok/perturbed-6-1/perturbed_6_1.png}
        \caption{}
        \label{fig:toytok-61-p}
    \end{subfigure}
    \caption{}
    \label{fig:toytok-61}
\end{figure}

A closer look at the x-point to show the correctness.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{images/toytok/perturbed-6-1/perturbed_6_1_closer.png}
    \caption{Caption}
    \label{fig:enter-label}
\end{figure}

\chapter{Tangles and Turnstile}

small epsilon when chaos appear the separation of a separatrix when.
KAM theory

\begin{figure}[h!]
    \centering
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{example-image-a}
        \caption{}
        \label{fig:}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{example-image-b}
        \caption{}
        \label{}
    \end{subfigure}
    \caption{}
    \label{}
\end{figure}

tangles for the tokamap, the henon map
we see that there were a separatrix and then they break to give.

and a really great can be found in \cite{hohloch_homoclinic_2017}\cite{hohloch_transport_2012}.
from poincare also called them trellis [cite]

\section{Stable and Unstable Manifolds}

manifold, manifold ordering.

algorithm to plot them, from.

\begin{figure}[H]
    \centering
    \begin{minipage}{0.45\textwidth} % Adjust width as needed
        \centering
        \begin{subfigure}[b]{\textwidth}
            \centering
            \includegraphics[width=\textwidth]{images/manifold/manifold_start.png}
            \caption{}
            \label{fig:}
        \end{subfigure}
        \vfill
        \vspace{10px}
        \vfill
        \begin{subfigure}[b]{0.99\textwidth}
            \centering
            \includegraphics[width=\textwidth]{images/manifold/manifold_closer.png}
            \caption{}
            \label{fig:}
        \end{subfigure}
    \end{minipage}%
    \begin{minipage}{0.5\textwidth} % Adjust width as needed
        \centering
        \begin{subfigure}[b]{\textwidth}
            \centering
            \includegraphics[width=\textwidth]{images/manifold/manifold.png}
            \caption{}
            \label{fig:}
        \end{subfigure}
    \end{minipage}
    \caption{}
    \label{fig:}
\end{figure}

laking behind due to the q-profile
the shape first goes out and then comes back.

the tangle structure they create

\section{Hetero/Homo-clinic points}

what are they and algorithm to find them

interested in primary homo-hetero clinic points, there definition.

algorithm to find them on 6/1 and the fact that we need to find another one, say that we can just initialize with lambda being half.

the rosenbruck structure, and the sneaking returns when the amplitude is increased

the fact that we have more than one
higher order homoclinic points
toyha in 3 2 

\begin{figure}[h!]
    \centering
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{example-image-a}
        \caption{}
        \label{fig:}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{example-image-b}
        \caption{}
        \label{}
    \end{subfigure}
    \caption{}
    \label{}
\end{figure}

the idea to initilize with specific epsilon values to have a nice initial guess. The fact that this is the main point were robustness may be increased.

\begin{figure}[h!]
    \centering
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{example-image-a}
        \caption{}
        \label{fig:}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{example-image-b}
        \caption{}
        \label{}
    \end{subfigure}
    \caption{}
    \label{}
\end{figure}

\section{Turnstile}

the definition of a bounded rezonance zone with island inside and a chaotic layer.

the formal definition by Meiss

\begin{figure}[h!]
    \centering
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/turnstile/01Resonance.png}
        \caption{}
        \label{fig:}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/turnstile/2DLobe.png}
        \caption{}
        \label{}
    \end{subfigure}
    \caption{\cite{meiss_thirty_2015}}
    \label{}
\end{figure}

[FIGURE with evolution entering and exiting sets]

How the conservation of the flux implies that the entering and exiting sets have the same flux.

the algorithm meiss uses.

\subsection{algorithm}

the use of stokes theorem, cite Meiss again.
The specific contour

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{images/turnstile/tokamak-tangles.png}
    \caption{Caption}
    \label{fig:enter-label}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/turnstile/line_tangle.png}
    \caption{Caption}
    \label{fig:enter-label}
\end{figure}

the mapping forward and backward to reduce the lenght and bring them back where there geometry is easy.

The first idea is to iterate the map until 
\begin{align*}
    \int\limits_{\gamma_i} \textbf{A}\cdot\textbf{dl} \leq \int\limits_{\gamma_i} \Vert\textbf{A}\Vert \Vert\textbf{dl}\Vert \leq\, L(\gamma_i)\max\limits_{\textbf{x} \in\gamma_i}\Vert\textbf{A(\textbf{x})}\Vert \lesssim L(\gamma_i)
\end{align*}
however this was found to work but a nice fix is that we don't need to 

then in the linear regime take just segments for gamma 1 and gamma 3 and approximate the integral which takes literally no time.

question ? why not just find the contour with many points and calculate a dot dl ? This is an idea however here we remember that the poincare map is performed by integrating the field and in the latter case of real stellarator geometry it will take long to compute for instance even 100 points in u and s. (200pts * 5 integrations each will give) 1000 necessary integration against only 2 once the homoclinics are found, this allows to use a higher tolerance on the integrator. Note in the case you also need to be sure that your grid is fine enough to have the intersections in it. The complexity is different, here it is used for verification.

actual calculation with the path 

\begin{figure}[H]
    \centering
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/turnstile/verification_triangle.png}
        \caption{}
        \label{fig:}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/turnstile/verification_loop.png}
        \caption{}
        \label{}
    \end{subfigure}
    \caption{}
    \label{}
\end{figure}

verification with triangle, 
 -3.890e-01
Area using the triangle approximation: -4.198e-01
Area using the integral of A on the loop approximation: -0.38584216929450854


shoelace formula 
\begin{equation*}
    \vert\Sigma_{lobe}\vert = \iint\limits_{\Sigma_{lobe}}1dx =  \iint\limits_{\Sigma_{lobe}}\frac{1}{2}\nabla\times (x\,\textbf{e}_y - y\,\textbf{e}_x)dx =  
\end{equation*}

and the a dot dl along the contour.

\subsection{Inner and outer turnstiles}

\begin{figure}[h!]
    \centering
    \begin{subfigure}[c]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/high-aspect-ratio/heteroclinics_outer_3.png}
        \caption{}
        \label{fig:}
    \end{subfigure}
    \hfill
    \begin{subfigure}[c]{0.49\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/high-aspect-ratio/closeup.png}
        \caption{}
        \label{}
    \end{subfigure}
    \caption{}
    \label{}
\end{figure}